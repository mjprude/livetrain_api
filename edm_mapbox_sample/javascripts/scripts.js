
// var containerSize;


L.mapbox.accessToken = 'pk.eyJ1IjoibWpwcnVkZSIsImEiOiJiVG8yR2VrIn0.jtdF6eqGIKKs0To4p0mu0Q';
var map = L.mapbox.map('map', 'mjprude.kcf5kl75')
            .setView([ 40.75583970971843, -73.90090942382812 ], 12);

var shuttleStationCoordinates = [ [ -73.986229, 40.755983000933206 ], [ -73.979189, 40.752769000933171 ] ];

// ******************* SVG OVERLAY GENERATION *******************
var svg = d3.select(map.getPanes().markerPane).append("svg");
// The "g" element to which we append thigns
var kennyPowers = svg.append("g").attr("class", "leaflet-zoom-hide");


// ******************* Projection abilities **********************
var transform = d3.geo.transform({
    point: projectPoint
});

// Line projection
var d3path = d3.geo.path().projection(transform);
function projectPoint(x, y) {
    var point = map.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point.x, point.y);
}


// Point Projection function
function applyLatLngToLayer(d) {
    var y = d[1];
    var x = d[0];
    return map.latLngToLayerPoint(new L.LatLng(y, x));
}


// Append stations
var originTerminus = kennyPowers.selectAll(".stations")
                                .data(shuttleStationCoordinates)
                                .enter()
                                .append('circle', '.stations')
                                .attr('r', '7')
                                .style('fill', 'red')
                                .style('opacity', '1');

// ******************* Map layer reset on user zoom ****************
function reset() {

  function getBounds(){
    var northBound = map.getBounds().getNorth();
    var westBound = map.getBounds().getWest();
    return applyLatLngToLayer([ westBound, northBound ]);
  }

  function anchorMap(){
    var mapAnchorPoints = getBounds();
    // Get map pixel size
    var mapSize = map.getSize();
    var mapWidth = mapSize.x;
    var mapHeight = mapSize.y;

    svg.attr('x', 0)
      .attr('y', 0)
      .attr('width', mapWidth)
      .attr('height', mapHeight)
      .style('transform', function(){
        return 'translate3d(' + mapAnchorPoints.x + 'px,' + mapAnchorPoints.y + "px, 0px)";
      });

    kennyPowers.style('transform', function(){
      return 'translate3d(' + -mapAnchorPoints.x + 'px,' + -mapAnchorPoints.y + "px, 0px)";
    });

  }

  anchorMap();

  originTerminus.attr('transform', function(d){
    return 'translate(' + applyLatLngToLayer(d).x + "," + applyLatLngToLayer(d).y + ")";
  });
}

map.on('viewreset', reset);
map.on('resize', reset);
map.on('move', reset);

reset();

// Adds path using mapbox....
d3.json("/subway_routes_geojson.json", function (json) {
  // var shapes = [[40.702068,-74.013664],[40.703199,-74.014792],[40.703226,-74.014820],[40.703253,-74.014846],[40.703280,-74.014870],[40.703307,-74.014893],[40.703335,-74.014914],[40.703363,-74.014933],[40.703391,-74.014952],[40.703419,-74.014968],[40.703448,-74.014983],[40.703477,-74.014997],[40.703506,-74.015009],[40.703536,-74.015019],[40.703566,-74.015028],[40.703596,-74.015035],[40.703625,-74.015041],[40.704168,-74.015122],[40.704194,-74.015125],[40.704221,-74.015126],[40.704247,-74.015127],[40.704274,-74.015127],[40.704300,-74.015125],[40.704327,-74.015123],[40.704354,-74.015119],[40.704380,-74.015115],[40.704407,-74.015109],[40.704434,-74.015102],[40.704461,-74.015094],[40.704487,-74.015086],[40.704514,-74.015076],[40.704541,-74.015065],[40.704568,-74.015052],[40.705092,-74.014830],[40.707513,-74.013783],[40.708242,-74.013471],[40.710132,-74.012648],[40.710500,-74.012529],[40.711112,-74.012375],[40.711565,-74.012259],[40.711835,-74.012188],[40.712105,-74.012108],[40.712154,-74.012094],[40.712203,-74.012076],[40.712252,-74.012057],[40.712300,-74.012035],[40.712348,-74.012012],[40.712394,-74.011986],[40.712440,-74.011959],[40.712486,-74.011929],[40.712530,-74.011897],[40.712574,-74.011864],[40.712618,-74.011828],[40.712660,-74.011791],[40.712702,-74.011751],[40.712743,-74.011710],[40.712783,-74.011667],[40.713212,-74.011138],[40.713229,-74.011116],[40.713246,-74.011094],[40.713263,-74.011073],[40.713280,-74.011052],[40.713298,-74.011032],[40.713315,-74.011011],[40.713333,-74.010992],[40.713351,-74.010972],[40.713369,-74.010953],[40.713388,-74.010935],[40.713406,-74.010917],[40.713425,-74.010899],[40.713444,-74.010882],[40.713463,-74.010865],[40.713482,-74.010848],[40.713841,-74.010573],[40.713961,-74.010473],[40.714303,-74.010188],[40.715437,-74.009299],[40.715478,-74.009266],[40.718032,-74.007249],[40.718063,-74.007227],[40.718095,-74.007206],[40.718127,-74.007186],[40.718160,-74.007167],[40.718193,-74.007150],[40.718228,-74.007133],[40.718262,-74.007117],[40.718298,-74.007103],[40.718334,-74.007089],[40.718370,-74.007077],[40.718408,-74.007066],[40.718446,-74.007055],[40.718484,-74.007046],[40.718523,-74.007038],[40.718563,-74.007031],[40.719318,-74.006886],[40.722854,-74.006277],[40.728251,-74.005367],[40.728935,-74.005260],[40.729169,-74.005221],[40.729283,-74.005197],[40.729414,-74.005160],[40.729532,-74.005112],[40.729642,-74.005062],[40.729881,-74.004935],[40.730321,-74.004682],[40.733422,-74.002906],[40.735973,-74.001452],[40.736162,-74.001345],[40.736358,-74.001229],[40.736585,-74.001089],[40.736761,-74.000973],[40.737826,-74.000201],[40.741040,-73.997871],[40.744081,-73.995657],[40.747215,-73.993365],[40.750373,-73.991057],[40.755290,-73.987495],[40.757342,-73.986009],[40.757638,-73.985786],[40.757758,-73.985709],[40.757880,-73.985638],[40.758014,-73.985569],[40.758156,-73.985512],[40.758375,-73.985421],[40.758631,-73.985330],[40.759405,-73.985063],[40.759714,-73.984959],[40.760017,-73.984841],[40.760283,-73.984725],[40.760592,-73.984577],[40.760821,-73.984444],[40.761040,-73.984294],[40.761728,-73.983849],[40.762486,-73.983358],[40.762980,-73.983038],[40.763412,-73.982793],[40.763714,-73.982626],[40.764029,-73.982464],[40.764386,-73.982320],[40.764821,-73.982156],[40.765125,-73.982063],[40.765461,-73.981977],[40.765808,-73.981910],[40.766808,-73.981755],[40.767172,-73.981702],[40.767324,-73.981689],[40.767440,-73.981694],[40.767561,-73.981697],[40.767681,-73.981718],[40.767778,-73.981745],[40.767895,-73.981781],[40.768247,-73.981929],[40.768454,-73.982012],[40.768582,-73.982053],[40.768695,-73.982078],[40.768794,-73.982088],[40.769222,-73.982098],[40.773440,-73.982209],[40.774166,-73.982212],[40.777496,-73.982091],[40.777869,-73.982058],[40.778211,-73.982008],[40.778453,-73.981970],[40.778822,-73.981906],[40.779426,-73.981757],[40.780996,-73.981314],[40.782155,-73.980924],[40.782374,-73.980847],[40.782622,-73.980748],[40.782794,-73.980664],[40.782970,-73.980572],[40.783149,-73.980473],[40.783313,-73.980371],[40.783934,-73.979917],[40.786953,-73.977656],[40.787601,-73.977107],[40.788644,-73.976218],[40.788957,-73.975942],[40.793919,-73.972323],[40.794005,-73.972265],[40.798506,-73.968980],[40.798570,-73.968931],[40.798635,-73.968882],[40.798699,-73.968835],[40.798763,-73.968789],[40.798827,-73.968745],[40.798890,-73.968702],[40.798954,-73.968660],[40.799016,-73.968620],[40.799079,-73.968582],[40.799141,-73.968544],[40.799203,-73.968509],[40.799264,-73.968474],[40.799326,-73.968441],[40.799386,-73.968410],[40.799446,-73.968379],[40.799772,-73.968210],[40.800124,-73.968082],[40.800510,-73.967980],[40.800870,-73.967929],[40.801984,-73.967832],[40.802298,-73.967789],[40.802605,-73.967719],[40.802781,-73.967649],[40.802929,-73.967582],[40.803121,-73.967465],[40.803324,-73.967313],[40.803967,-73.966847],[40.807722,-73.964110],[40.815581,-73.958372],[40.822008,-73.953676],[40.826551,-73.950360],[40.834041,-73.944890],[40.840556,-73.940133],[40.849505,-73.933596],[40.855225,-73.929412],[40.860531,-73.925536],[40.861000,-73.925190],[40.861102,-73.925109],[40.861204,-73.925016],[40.861303,-73.924914],[40.861396,-73.924807],[40.861516,-73.924645],[40.861621,-73.924492],[40.861712,-73.924333],[40.861805,-73.924151],[40.861888,-73.923966],[40.863121,-73.920631],[40.863239,-73.920305],[40.863349,-73.920049],[40.863451,-73.919867],[40.863561,-73.919696],[40.863669,-73.919565],[40.863782,-73.919442],[40.863950,-73.919309],[40.864621,-73.918822],[40.869444,-73.915279],[40.870276,-73.914666],[40.870986,-73.914141],[40.871376,-73.913803],[40.871758,-73.913415],[40.872111,-73.913000],[40.872766,-73.912201],[40.874278,-73.910249],[40.874561,-73.909831],[40.874686,-73.909650],[40.875276,-73.908878],[40.875770,-73.908261],[40.876002,-73.907950],[40.876213,-73.907623],[40.876388,-73.907296],[40.876597,-73.906883],[40.876765,-73.906585],[40.876957,-73.906305],[40.877176,-73.906061],[40.877584,-73.905744],[40.878856,-73.904834],[40.882525,-73.902223],[40.882988,-73.901899],[40.883467,-73.901602],[40.884461,-73.900991],[40.884667,-73.900870],[40.884928,-73.900730],[40.886309,-73.900041],[40.887195,-73.899616],[40.889248,-73.898583]]

  // Generate a GeoJSON line. You could also load GeoJSON via AJAX
  // or generate it some other way.
  var geojson = { type: 'LineString', coordinates: [] };

  // path = json.features[0].geometry.coordinates;
  // shapes = [].concat.apply([], shapes);
  // shapes.forEach(function(shape){
  //   geojson.coordinates.push([shape[1], shape[0]]);
  // });


  // Add this generated geojson object to the map.
  L.geoJson(json).addTo(map);

});



$(function(){
  
  // function placeDots(){
  //   var shuttleStationCoordinates = [ [ -73.986229, 40.755983000933206 ], [ -73.979189, 40.752769000933171 ] ];
  //   containerSize = map.getSize();
  //   console.log(map.getBounds().getSouth() + ", " + map.getBounds().getNorth());
  //   var latScale = d3.scale.linear()
  //                     .domain([ map.getBounds().getNorth(), map.getBounds().getSouth() ])
  //                     .range([ 0, 500 ]);

  //   var longScale = d3.scale.linear()
  //                     .domain([ map.getBounds().getWest(), map.getBounds().getEast() ])
  //                     .range([ 0, 500 ]);


  //   d3.select('.leaflet-zoom-hide').selectAll('circle')
  //     .data(coordinates)
  //     .enter()
  //     .append('circle')
  //     .attr('r', 10)
  //     .attr('cx', function(d){ return d[0]; })
  //     .attr('cy', function(d){ return d[1]; })
  //     .style('fill', 'red')
  //     .transition()
  //     .attr('cx', 500);
  // }

  // reset();

})

